FROM amazonlinux:2023 AS runtime

# Update system first
RUN dnf -y update && dnf clean all

# Copy package setup script
COPY miscellaneous/docker/package-setup /tmp/
RUN chmod +x /tmp/package-setup && /tmp/package-setup

WORKDIR /var/www/{{ project_name }}

COPY composer.json composer.lock ./
RUN composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader

##################################################################
#           Copy Project data
##################################################################
COPY . .

##################################################################
#           RUN CONFIGURATION SETUP
##################################################################
COPY miscellaneous/docker/config-setup /tmp/
RUN chmod +x /tmp/config-setup && /tmp/config-setup

##################################################################
#           VERIFY VENDOR DIRECTORY & NGINX CONFIG
##################################################################
COPY miscellaneous/docker/verify /tmp/
RUN chmod +x /tmp/verify && /tmp/verify

##################################################################
#           ADD ENTRYPOINT SCRIPT
##################################################################
COPY miscellaneous/docker/entrypoint /usr/local/bin/entrypoint.sh

# Fix line endings and permissions for entrypoint script
RUN dnf install -y dos2unix && \
    dos2unix /usr/local/bin/entrypoint.sh && \
    chmod +x /usr/local/bin/entrypoint.sh && \
    # Simple verification that the file exists and is executable
    [ -f /usr/local/bin/entrypoint.sh ] && [ -x /usr/local/bin/entrypoint.sh ] || (echo "Entrypoint script verification failed" && exit 1)

##################################################################
#           EXPOSE PORT & SET ENTRYPOINT
##################################################################
EXPOSE 80

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]